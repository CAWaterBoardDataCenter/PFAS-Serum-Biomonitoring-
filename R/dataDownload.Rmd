---
title: "PFAS_exposure_assessment"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#INTRODUCTION

This script pulls all California drinking water monitoring data for the previous 5 years from SDWIS, filters for PFAS data, and spatially joins drinking water well monitoring data with service area boundary layers.

#Resources

system boundaries homepage
https://gis.data.ca.gov/datasets/waterboards::california-drinking-water-system-area-boundaries?geometry=-148.883%2C31.064%2C-89.601%2C43.271

API for water system boundary layer
https://opendata.arcgis.com/datasets/fbba842bf134497c9d611ad506ec48cc_0.geojson

#Setup
```{r}
library(tidyverse)
library(foreign)
library(readxl)
library(vroom) #much faster than readr for CSVs
library(sf) #read shapefiles
library(rgdal) #read OGR vector maps into spatial objects
```

## Data Import
### Chemical Data
```{r}
##### download, upzip, and read most recent data and chemical storet info ####
urls <- c("https://www.waterboards.ca.gov/drinking_water/certlic/drinkingwater/documents/edtlibrary/chemical_as_csv.zip",
          "https://www.waterboards.ca.gov/drinking_water/certlic/drinkingwater/documents/edtlibrary/storet_as_dbf.zip",
          'https://www.waterboards.ca.gov/drinking_water/certlic/drinkingwater/documents/edtlibrary/siteloc_as_dbf.zip',
          'https://geotracker.waterboards.ca.gov/gama/data_download/gama_ddw_statewide.zip')
temp1 <- temp2 <- temp3 <- temp4<- tempfile()

download.file(urls[1], temp1)
unzip(temp1, 
      exdir = "temp")

download.file(urls[2], temp2)
unzip(temp2,
      exdir = "temp")

download.file(urls[3], temp3)
unzip(temp3,
      exdir = "temp")

download.file(urls[4], temp3)
unzip(temp4,
      exdir = "temp")

rm(temp1, temp2, temp3, temp4) # remove temp files

#### read chem and storet data into R ####
# sometimes, R fails to unzip `chem`. unsure why, but manual download/unzip works
chem  <- vroom("temp/chemical.csv")
stor  <- read.dbf("temp/storet.dbf")
siteloc <- read.dbf("temp/siteloc.dbf")
gama <- vroom("temp/gama_ddw_statewide.txt") # GAMA data, includes drinking water under source == "DHS"

# SDWIS data updates periodically, breaking the csv in url:
# https://data.ca.gov/dataset/drinking-water-public-water-system-information
sdwis <- vroom("https://data.ca.gov/dataset/d6d3beac-6735-4127-9324-4e70f61698d9/resource/9dca2f92-4630-4bee-a9f9-69d2085b57e3/download/drinking-water-watch-public-water-system-facilities.txt")

# make equivalent water system identifers 
sdwis$`Water System No` <- str_sub(sdwis$`Water System No`, 3, 9)
chem$PRIM_STA_C <- str_sub(chem$PRIM_STA_C, 1, 7)
#gama$`WELL ID` <- str_sub(gama$`WELL ID`,1,7) #separate water system ID from wells


##### join chem,storet, and location data ####
chem <- left_join(chem, stor, by = "STORE_NUM")
chem <- left_join(chem, sdwis, by = c("PRIM_STA_C" = "Water System No"))
chem <- left_join(chem, gama, by = c("PRIM_STA_C" = "WELL ID"))
chem <- chem %>% rename(chemical = CHEMICAL__)
# write the joined data (optional, takes a while)
#write_rds(chem, "chem.rds")
```

#### Unique chemicals
```{r}
#get unique names of chemicals for filtering
unique(chem$chemical) %>% sort()
```

#### Filter for PFAS
```{r}
#make list of PFAS and filter
pfaslist <- c('PERFLUOROBUTANESULFONIC ACID (PFBS)',
'PERFLUORODECANOIC ACID (PFDA)',
'PERFLUORODODECANOIC ACID (PFDoA)',
'PERFLUOROHEPTANOIC ACID (PFHpA)',
'PERFLUOROHEXANE SULFONIC ACID (PFHxS)',
'PERFLUOROHEXANOIC ACID (PFHxA)',
'PERFLUORONONANOIC ACID (PFNA)',
'PERFLUOROOCTANE SULFONIC ACID (PFOS)',
'PERFLUOROOCTANOIC ACID (PFOA)',
'PERFLUOROTETRADECANOIC ACID (PFTA)',
'PERFLUOROTRIDECANOIC ACID (PFTrDA)',
'PERFLUOROUNDECANOIC ACID (PFUnA)')

#filter for PFAS data and delete the rest
pfas <- chem %>% 
  filter(chemical %in% pfaslist)
rm(chem,sdwis, siteloc, stor, pfaslist, urls)
```
## Spatial Data
```{r}
SABL_link <- "https://opendata.arcgis.com/datasets/fbba842bf134497c9d611ad506ec48cc_0.zip"
temp <- tempfile()
temp2 <- tempfile()
download.file(SABL_link, temp)
unzip(zipfile = temp, exdir = temp2)
#open with rgdal
SABL <- readOGR(dsn = temp2, layer = "California_Drinking_Water_System_Area_Boundaries")
#or open with sf
SABL <- sf::st_read(paste0(temp2, "/California_Drinking_Water_System_Area_Boundaries.shp"))
unlink(temp)
unlink(temp2)
```

### Spatial Join to System Area Boundary Layer
```{r}
PFAS_data <- read.dbf("PFAS_SPAspatialjoin.dbf", as.is = T)

SPA_avg <- PFAS_data %>% group_by(SPAs_ABBV, CHEMICAL) %>% summarize(spa_chem_mean = mean(RESULTS, na.rm = T))
print.data.frame(SPA_avg)


#biomonitoring data
#fix in the future
cdphdatalink <- 'https://github.com/CAWaterBoardDataCenter/PFAS-Serum-Biomonitoring-/blob/master/PFASSerumData.csv'
tf <- tempfile()
biodata <- download.file(tf, cdphdatalink)

biodata <- read.csv("PFASSerumData.csv", stringsAsFactors = F)
biodata_long <- biodata %>% gather(CHEMICAL, RESULTS, PFDeA:MeFOS, factor_key = F)

#plot age against PFAS concentration
gg <- ggplot(biodata_long, aes(x = age, y = RESULTS, color = SPAZip)) +
  geom_point()
gg

#plot location against PFAS concention
varwidth = 20
biodata_long <- biodata_long %>% mutate(prettyvar = )
ggplot(biodata_long, aes(x = SPAZip, y = RESULTS, fill = SPAZip)) +
  geom_boxplot() +
  facet_wrap(~CHEMICAL, scales = "free") +
  labs(title = "Blood Serum Concentrations (ppb)", xlab = "SPA")



#make column names the same  
SPA_avg_rename <- SPA_avg %>% separate(SPAs_ABBV, into = c("SPA", "SPANo"), sep = " ")
SPA_avg_rename$SPANo <- as.numeric(SPA_avg_rename$SPANo)
SPA_nonulls <- SPA_avg_rename %>% filter(!is.na(SPA))
SPA_nonulls <- SPA_nonulls %>% mutate(concat = paste0(SPANo, CHEMICAL))

biodata_long <- biodata_long %>% mutate(concat = paste0(SPANo, CHEMICAL))

#join bio data with wq data
df <- left_join(biodata_long, SPA_nonulls)
df <- df %>% filter(!is.na(spa_chem_mean))


sp <- ggplot(df, aes(x = spa_chem_mean, y = RESULTS, color = SPAZip)) + geom_point() +
facet_wrap(~CHEMICAL)
sp
```

## Emily's Method for Spatial Joins
EMILY: Just took a quick look and I believe the PFAS_SPAspatialjoin.dbf was created by spatially joining the well points with PFAS water quality data (lat/long) to the SPA (Los Angeles Service Planning Areas) polygons so that we could get average PFAS values for each SPA (the level at which the health data was at). This can be done within R, if that would be helpful (if your analysis is using health data in areas other than SPAs, like zip codes, the same spatial join could be done with a different .shp file). Example code below. I don't have the original PFAS water quality data or the original SPA shapefile on this laptop, but I can help write code to grab the water quality data ("wells", below) if needed! Or if you already have water quality data with lat/long, you can feed it though this.

```{r}
#read shapefile with SPA polygons
SABL <- st_read("California_Drinking_Water_System_Area_Boundaries.shp")
#transform shapefile (if necessary)
spa_wgs <- st_transform(spa, crs = 4326)
#transform data frame with well points and water quality data into sf object
PFAS_sf <- st_as_sf(PFAS, coords = c('LONGITUDE', 'LATITUDE'), crs = 4326)
#intersect well points with SPA polygons
wells_int <- st_join(PFAS_sf, left = TRUE, spa_wgs["SPA_Name"])
#the wells_int file should then replicate the data within "PFAS_SPAspatialjoin.dbf"
```


## Alternative Method for Spatial Joins

First make intersection between all available polygons in the two layers. Next, calculate the area of each polygon in each of the two layers and then the area of all intersections. The "weight" of each intersection's contribution to the water system overall is then (Area_intersection/Area_SPA_polygon), and the overall aggregated total for the system would be sum(weight*zip_variable).

Note that this isn't always perfect, as sometimes you have missing polygons for either the system or the zips (or your sums total for the zip level information is WAY off from the water system total-- population is a big one here) however, it's useful for knowing PROPORTIONAL representation of variables, like the race and age


```{r}
library(readxl)
urws_tracts_intersect_joined <- read_excel("datasets/urws_tracts_intersect_joined.xlsx")
View(urws_tracts_intersect_joined)
```

### System Area Boundary Project
Wendy Killou:
Here is a status of our System Area Boundary Project, which involves several sub components to the overall project.

SABL verification of current community water system boundary layers is now estimated be done around July 2021.

SABL Admin App – the intake system for water system boundary shape files is scheduled to be released to the public water systems sometime after 3/15/2021.  We are currently testing it with internal staff to make sure things are working correctly.

SABL Look-up App – is now available.  It is a look-up tool to see what the current boundary is for the water system and information related to the water system.  Note that there is continuous updates being made to the boundaries and tool itself.

Latest version of the boundary data available on the GeoPortal site.  This is the current site that you can download the layer in various file types.

The overlapping of water system boundaries that you mentioned in your email is being looked at when water system boundaries are being validated/verified by staff.  Once we start to get updated boundaries from water systems directly through the SABL Admin App we are hoping that the overlaps are reduced.  Please keep in mind that our system area boundary type definitions are NOT a legal definition and should NOT be used to settle boundary disputes.

Because the Water Board is targeting different information, there is no conflict with other authoritative agencies definitions.
